<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pro Concept Map Builder</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  :root {
    --bg: #0c173a;
    --panel-bg: #14284f;
    --accent: #60a5fa;
    --text-light: #e4ebff;
    --text-muted: #7a9acd;
    --border: #2c4dab;
    --shadow: rgba(92, 160, 250, 0.5);
    --grid-color: rgba(96, 165, 250, 0.15);
    --spacing: 12px;
  }
  * {
    box-sizing: border-box;
  }
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text-light);
    user-select: none;
  }
  body > .app {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  header {
    height: 56px;
    background: var(--panel-bg);
    display: flex;
    align-items: center;
    padding: 0 var(--spacing);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 0 12px var(--shadow);
  }
  header h1 {
    font-weight: 600; font-size: 18px;
    flex: 1;
  }
  header .toolbar button {
    margin-left: 8px;
    background: transparent;
    border: 1.5px solid var(--accent);
    color: var(--accent);
    font-weight: 600;
    font-size: 13px;
    padding: 6px 14px;
    border-radius: 12px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease, color 0.2s ease;
  }
  header .toolbar button:hover {
    background: var(--accent);
    color: var(--bg);
    box-shadow: 0 0 10px var(--accent);
  }
  header .toolbar .btn-primary {
    border: none;
    background: var(--accent);
    color: var(--bg);
    box-shadow: 0 0 16px var(--accent);
  }
  main {
    flex: 1;
    display: flex;
    gap: var(--spacing);
    padding: var(--spacing);
  }
  .side-panel {
    background: var(--panel-bg);
    border-radius: 16px;
    padding: 16px;
    width: 220px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 24px var(--shadow);
  }
  .palette h3, .inspector h3 {
    margin: 0 0 16px 0;
    font-weight: 600;
    color: var(--accent);
    font-size: 15px;
    letter-spacing: 0.06em;
  }
  .shape-item {
    display: flex;
    align-items: center;
    padding: 10px 14px;
    border-radius: 12px;
    background: rgba(96, 165, 250, 0.1);
    margin-bottom: 14px;
    font-weight: 600;
    font-size: 14px;
    color: var(--accent);
    cursor: grab;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .shape-item:hover {
    background: var(--accent);
    color: var(--bg);
  }
  .shape-item .icon {
    width: 28px;
    height: 28px;
    margin-right: 12px;
    font-weight: 900;
    font-size: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .canvas-container {
    flex: 1;
    position: relative;
    border-radius: 20px;
    background: #0a1b3a;
    box-shadow: inset 0 0 30px #05173b;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  #grid {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(var(--grid-color) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
    background-size: 20px 20px;
    pointer-events: none;
  }
  svg#canvas-svg {
    width: 100%;
    height: 100%;
    cursor: grab;
    user-select: none;
    display: block;
  }
  .inspector {
    width: 280px;
    background: var(--panel-bg);
    padding: 16px;
    border-radius: 16px;
    box-shadow: 0 0 24px var(--shadow);
    display: flex;
    flex-direction: column;
    color: var(--text-muted);
  }
  .inspector h3 {
    margin-bottom: 12px;
    color: var(--accent);
    font-weight: 700;
    letter-spacing: 0.06em;
  }
  .inspector label {
    font-weight: 600;
    font-size: 14px;
    margin-top: 12px;
  }
  .inspector input[type=text],
  .inspector select,
  .inspector input[type=color],
  .inspector input[type=number] {
    margin-top: 6px;
    padding: 8px 12px;
    font-weight: 700;
    font-size: 14px;
    background: #0d2240;
    border: none;
    border-radius: 12px;
    color: var(--accent);
    outline: none;
    box-shadow: inset 0 0 8px #142d7c;
    transition: box-shadow 0.3s ease;
  }
  .inspector input[type=text]:focus,
  .inspector select:focus,
  .inspector input[type=color]:focus,
  .inspector input[type=number]:focus {
    box-shadow: inset 0 0 14px var(--accent);
  }
  .inspector button {
    margin-top: 20px;
    padding: 12px 0;
    font-weight: 700;
    font-size: 15px;
    background: var(--accent);
    border: none;
    border-radius: 16px;
    color: var(--bg);
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .inspector button:hover {
    background: var(--accent-light);
  }
  .selected-outline {
    stroke: var(--accent);
    stroke-width: 3;
    stroke-dasharray: 8 6;
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Pro Concept Map Builder</h1>
    <nav class="toolbar" aria-label="Toolbar">
      <button id="undo">↶ Undo</button>
      <button id="redo">↷ Redo</button>
      <button id="copy">Copy</button>
      <button id="paste">Paste</button>
      <button id="duplicate">Duplicate</button>
      <button id="deleteSelected">Delete</button>
      <button id="zoomIn">Zoom +</button>
      <button id="zoomOut">Zoom -</button>
      <button id="fit">Fit</button>
      <button id="exportSvg">Export SVG</button>
      <button id="exportPng" class="btn-primary">Export PNG</button>
    </nav>
  </header>
  <main>
    <aside class="side-panel palette" aria-label="Shapes palette">
      <h3>Shapes</h3>
      <div class="shape-item" draggable="true" data-shape="rect"><span class="icon">▭</span>Rectangle</div>
      <div class="shape-item" draggable="true" data-shape="ellipse"><span class="icon">⬭</span>Ellipse</div>
      <div class="shape-item" draggable="true" data-shape="circle"><span class="icon">●</span>Circle</div>
      <div class="shape-item" draggable="true" data-shape="diamond"><span class="icon">◇</span>Diamond</div>
      <div class="shape-item" draggable="true" data-shape="triangle"><span class="icon">▲</span>Triangle</div>
      <div class="shape-item" draggable="true" data-shape="note"><span class="icon">✎</span>Note</div>
    </aside>
    <section class="canvas-container" aria-label="Concept map canvas">
      <div id="grid"></div>
      <svg id="canvas-svg" tabindex="0"></svg>
    </section>
    <aside class="side-panel inspector" aria-label="Properties inspector" hidden>
      <h3>Inspector</h3>
      <label for="insLabel">Label</label>
      <input type="text" id="insLabel" placeholder="Shape label" />
      <label for="insFillColor">Fill Color</label>
      <input type="color" id="insFillColor" value="#60a5fa" />
      <label for="insBorderColor">Border Color</label>
      <input type="color" id="insBorderColor" value="#2c4dab" />
      <label for="insFontSize">Font Size</label>
      <select id="insFontSize">
        <option>12</option><option>14</option><option selected>16</option><option>18</option><option>20</option>
      </select>
      <label for="insBorderWidth">Border Width</label>
      <input type="number" id="insBorderWidth" placeholder="2" value="2" min="1" max="8" />
      <label for="insOpacity">Opacity</label>
      <input type="number" id="insOpacity" placeholder="1" step="0.05" value="1" min="0.1" max="1" />
      <button id="applyStyle">Apply</button>
      <button id="deleteSelectedBtn" style="background:#b24c4c;color:#fff;">Delete Selected</button>
    </aside>
  </main>
</div>
<script>
(() => {
  const svgNS = "http://www.w3.org/2000/svg";

  const canvasSvg = document.getElementById('canvas-svg');
  const canvasContainer = document.querySelector('.canvas-container');
  const inspector = document.querySelector('.inspector');

  const undoBtn = document.getElementById('undo');
  const redoBtn = document.getElementById('redo');
  const copyBtn = document.getElementById('copy');
  const pasteBtn = document.getElementById('paste');
  const duplicateBtn = document.getElementById('duplicate');
  const deleteBtn = document.getElementById('deleteSelected');
  const deleteBtn2 = document.getElementById('deleteSelectedBtn');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const fitBtn = document.getElementById('fit');
  const exportSvgBtn = document.getElementById('exportSvg');
  const exportPngBtn = document.getElementById('exportPng');

  const insLabelInput = document.getElementById('insLabel');
  const insFillColorInput = document.getElementById('insFillColor');
  const insBorderColorInput = document.getElementById('insBorderColor');
  const insFontSizeSelect = document.getElementById('insFontSize');
  const insBorderWidthInput = document.getElementById('insBorderWidth');
  const insOpacityInput = document.getElementById('insOpacity');
  const applyStyleBtn = document.getElementById('applyStyle');

  const GRID_SIZE = 20;

  let shapes = [];
  let connectors = [];
  let selected = [];
  let copiedShapes = [];
  let undoStack = [];
  let redoStack = [];
  let zoomLevel = 1;
  let dragState = null;

  function uuid() { return "id-" + Math.random().toString(36).substr(2, 9); }

  function snapshot() {
    undoStack.push(JSON.stringify({shapes: structuredClone(shapes), connectors: structuredClone(connectors)}));
    redoStack = [];
    updateUndoRedoButtons();
  }

  function restore(stateStr) {
    const obj = JSON.parse(stateStr);
    shapes = obj.shapes;
    connectors = obj.connectors;
    selected = [];
    render();
  }

  function updateUndoRedoButtons(){
    undoBtn.disabled = undoStack.length===0;
    redoBtn.disabled = redoStack.length===0;
  }

  function addShape(type, x, y) {
    const shape = {
      id: uuid(), type, x, y, w:120, h:60, r:0, text:type.toUpperCase(),
      fill:"#60a5fa", stroke:"#2c4dab", fontSize:16, strokeWidth:2, opacity:1
    };
    shapes.push(shape);
    snapshot();
    render();
  }

  function makeSVG(tag, attrs, text){
    const el = document.createElementNS(svgNS, tag);
    for(const k in attrs) if(attrs[k]!==undefined&&attrs[k]!==null) el.setAttribute(k,attrs[k]);
    if(text!==undefined) el.textContent=text;
    return el;
  }

  function render() {
    canvasSvg.innerHTML="";

    const width = canvasSvg.clientWidth;
    const height = canvasSvg.clientHeight;

    // Grid pattern
    const defs = makeSVG("defs",{});
    const pattern = makeSVG("pattern",{id:"gridPattern",patternUnits:"userSpaceOnUse",width:GRID_SIZE,height:GRID_SIZE});
    pattern.appendChild(makeSVG("line",{x1:0,y1:0,x2:GRID_SIZE,y2:0,stroke:"rgba(96,165,250,0.15)","stroke-width":1}));
    pattern.appendChild(makeSVG("line",{x1:0,y1:0,x2:0,y2:GRID_SIZE,stroke:"rgba(96,165,250,0.15)","stroke-width":1}));
    defs.appendChild(pattern);

    // Arrow marker
    const marker = makeSVG("marker",{id:"arrowmarker",viewBox:"0 0 10 10",refX:9,refY:5,
      markerUnits:"strokeWidth",markerWidth:6,markerHeight:6,orient:"auto"});
    marker.appendChild(makeSVG("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:"#a9c7ff"}));
    defs.appendChild(marker);
    canvasSvg.appendChild(defs);

    // Full-page grid
    canvasSvg.appendChild(makeSVG("rect",{x:0,y:0,width:width,height:height,fill:"url(#gridPattern)"}));

    // Connectors
    connectors.forEach(c=>{
      const from = shapes.find(s=>s.id===c.from);
      const to = shapes.find(s=>s.id===c.to);
      if(!from||!to) return;
      canvasSvg.appendChild(makeSVG("line",{
        x1:from.x+from.w/2, y1:from.y+from.h/2,
        x2:to.x+to.w/2, y2:to.y+to.h/2,
        stroke:"#a9c7ff","stroke-width":2,"marker-end":"url(#arrowmarker)"
      }));
    });

    // Shapes
    shapes.forEach(shape=>{
      const g = makeSVG("g",{transform:`translate(${shape.x},${shape.y}) rotate(${shape.r},${shape.w/2},${shape.h/2})`,opacity:shape.opacity});
      let el, common={fill:shape.fill,stroke:shape.stroke,"stroke-width":shape.strokeWidth};
      switch(shape.type){
        case"rect": el=makeSVG("rect",{width:shape.w,height:shape.h,rx:14,ry:14,...common}); break;
        case"ellipse": el=makeSVG("ellipse",{cx:shape.w/2,cy:shape.h/2,rx:shape.w/2,ry:shape.h/2,...common}); break;
        case"circle": el=makeSVG("circle",{cx:shape.w/2,cy:shape.h/2,r:Math.min(shape.w,shape.h)/2,...common}); break;
        case"diamond": el=makeSVG("polygon",{points:`${shape.w/2},0 ${shape.w},${shape.h/2} ${shape.w/2},${shape.h} 0,${shape.h/2}`,...common}); break;
        case"triangle": el=makeSVG("polygon",{points:`${shape.w/2},0 ${shape.w},${shape.h} 0,${shape.h}`,...common}); break;
        case"note": el=makeSVG("rect",{width:shape.w,height:shape.h,fill:"#fffbe6",stroke:shape.stroke,"stroke-width":2}); break;
        default: el=makeSVG("rect",{width:shape.w,height:shape.h,...common});
      }
      el.style.cursor="grab";
      el.addEventListener("mousedown",(e)=>shapeMouseDown(e,shape));
      g.appendChild(el);

      const textColor = shape.type==="note"?"#07162a":"#e4ebff";
      g.appendChild(makeSVG("text",{x:shape.w/2,y:shape.h/2,"text-anchor":"middle","dominant-baseline":"middle",
        "font-weight":"700","font-size":shape.fontSize,fill:textColor,style:"pointer-events:none;user-select:none"},shape.text));

      if(selected.includes(shape.id)){
        g.appendChild(makeSVG("rect",{x:-8,y:-8,width:shape.w+16,height:shape.h+16,fill:"none",
          stroke:"var(--accent)","stroke-width":3,"stroke-dasharray":"8 4","pointer-events":"none"}));
      }

      canvasSvg.appendChild(g);
    });

    updateInspector();
  }

  function shapeMouseDown(e, shape){
    e.stopPropagation();
    if(!e.shiftKey) selected=[shape.id];
    else selected = selected.includes(shape.id)? selected.filter(id=>id!==shape.id):[...selected,shape.id];
    dragState={shape, origX:shape.x, origY:shape.y, startX:e.clientX, startY:e.clientY};
    window.addEventListener("mousemove", onDrag);
    window.addEventListener("mouseup", onDrop);
    render();
  }

  function onDrag(e){
    if(!dragState) return;
    const dx = e.clientX - dragState.startX;
    const dy = e.clientY - dragState.startY;
    selected.forEach(id=>{
      const s=shapes.find(x=>x.id===id);
      if(s){ s.x=Math.round((dragState.origX+dx)/GRID_SIZE)*GRID_SIZE; s.y=Math.round((dragState.origY+dy)/GRID_SIZE)*GRID_SIZE; }
    });
    render();
  }

  function onDrop(){ if(dragState) snapshot(); dragState=null; window.removeEventListener("mousemove",onDrag); window.removeEventListener("mouseup",onDrop); }

  canvasSvg.addEventListener("mousedown", e=>{ if(e.target===canvasSvg&&!e.shiftKey){ selected=[]; render(); } });

  function updateInspector(){
    if(selected.length===1){
      inspector.hidden=false;
      const s=shapes.find(x=>x.id===selected[0]);
      insLabelInput.value=s.text; insFillColorInput.value=s.fill; insBorderColorInput.value=s.stroke;
      insFontSizeSelect.value=s.fontSize; insBorderWidthInput.value=s.strokeWidth; insOpacityInput.value=s.opacity;
    } else inspector.hidden=true;
  }

  applyStyleBtn.addEventListener("click",()=>{
    if(selected.length!==1) return;
    snapshot();
    const s=shapes.find(x=>x.id===selected[0]);
    s.text=insLabelInput.value;
    s.fill=insFillColorInput.value;
    s.stroke=insBorderColorInput.value;
    s.fontSize=parseInt(insFontSizeSelect.value);
    s.strokeWidth=parseInt(insBorderWidthInput.value);
    s.opacity=parseFloat(insOpacityInput.value);
    render();
  });

  function deleteSelectedShapes(){
    if(selected.length===0) return;
    snapshot();
    shapes=shapes.filter(s=>!selected.includes(s.id));
    connectors=connectors.filter(c=>!selected.includes(c.from)&&!selected.includes(c.to));
    selected=[];
    render();
  }
  deleteBtn.addEventListener("click",deleteSelectedShapes);
  deleteBtn2.addEventListener("click",deleteSelectedShapes);

  undoBtn.addEventListener("click",()=>{
    if(!undoStack.length) return;
    redoStack.push(JSON.stringify({shapes: structuredClone(shapes), connectors: structuredClone(connectors)}));
    const prev = undoStack.pop();
    restore(prev);
  });
  redoBtn.addEventListener("click",()=>{
    if(!redoStack.length) return;
    undoStack.push(JSON.stringify({shapes: structuredClone(shapes), connectors: structuredClone(connectors)}));
    const next = redoStack.pop();
    restore(next);
  });

  copyBtn.addEventListener("click",()=>{ copiedShapes=shapes.filter(s=>selected.includes(s.id)).map(s=>({...s})); });
  pasteBtn.addEventListener("click",()=>{
    if(!copiedShapes.length) return;
    snapshot();
    const newShapes=copiedShapes.map(s=>{
      const copy={...s,id:uuid(),x:s.x+20,y:s.y+20};
      shapes.push(copy);
      return copy.id;
    });
    selected=newShapes;
    render();
  });

  duplicateBtn.addEventListener("click",()=>{
    if(!selected.length) return;
    snapshot();
    const toCopy=shapes.filter(s=>selected.includes(s.id));
    const newIds = [];
    toCopy.forEach(s=>{
      const copy={...s,id:uuid(),x:s.x+20,y:s.y+20};
      shapes.push(copy);
      newIds.push(copy.id);
    });
    selected=newIds;
    render();
  });

  // Zoom
  zoomInBtn.addEventListener("click",()=>{ zoomLevel*=1.2; applyZoom(); });
  zoomOutBtn.addEventListener("click",()=>{ zoomLevel/=1.2; applyZoom(); });
  fitBtn.addEventListener("click",()=>{ zoomLevel=1; applyZoom(); });
  function applyZoom(){ canvasSvg.style.transform=`scale(${zoomLevel})`; }

  // Export
  exportSvgBtn.addEventListener("click",()=>{
    const svgBlob = new Blob([canvasSvg.outerHTML],{type:"image/svg+xml"});
    const url = URL.createObjectURL(svgBlob);
    const a=document.createElement("a"); a.href=url; a.download="concept-map.svg"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  });

  exportPngBtn.addEventListener("click",()=>{
    const xml=new XMLSerializer().serializeToString(canvasSvg);
    const svg64=btoa(xml);
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement("canvas"); canvas.width=canvasSvg.clientWidth*2; canvas.height=canvasSvg.clientHeight*2;
      const ctx=canvas.getContext("2d"); ctx.fillStyle="#0c173a"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height);
      const pngFile=canvas.toDataURL("image/png"); const a=document.createElement("a"); a.href=pngFile
      a.download="concept-map.png"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    };
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(xml)));
  });

  // Drag & Drop from Palette
  document.querySelectorAll('.palette-item').forEach(item=>{
    item.setAttribute("draggable",true);
    item.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", item.dataset.type);
    });
  });

  canvasContainer.addEventListener("dragover", e=>{ e.preventDefault(); });
  canvasContainer.addEventListener("drop", e=>{
    e.preventDefault();
    const type = e.dataTransfer.getData("text/plain");
    const rect = canvasSvg.getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left)/GRID_SIZE)*GRID_SIZE;
    const y = Math.round((e.clientY - rect.top)/GRID_SIZE)*GRID_SIZE;
    addShape(type, x, y);
  });

  // Connectors: Ctrl+Click on 2 shapes
  let connectorStart = null;
  canvasSvg.addEventListener("click", e=>{
    if(!e.ctrlKey) return;
    const targetShape = shapes.find(s=>{
      const left=s.x, top=s.y, right=s.x+s.w, bottom=s.y+s.h;
      return e.offsetX>=left && e.offsetX<=right && e.offsetY>=top && e.offsetY<=bottom;
    });
    if(!targetShape) return;
    if(!connectorStart) connectorStart = targetShape.id;
    else{
      connectors.push({from:connectorStart,to:targetShape.id});
      connectorStart = null;
      snapshot();
      render();
    }
  });

  // Initial render
  render();
})();
</script>

</body>
</html>
